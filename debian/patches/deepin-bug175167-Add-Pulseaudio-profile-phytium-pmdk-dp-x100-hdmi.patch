From 8f28fd0f4532d669dd6d2b292dcaa94ee8cc7ec8 Mon Sep 17 00:00:00 2001
From: zhaochengyi <zhaochengyi@uniontech.com>
Date: Thu, 23 Feb 2023 16:22:31 +0800
Subject: [PATCH]  Add Pulseaudio profile phytium-pmdk-dp-x100-hdmi.conf  to
 adapt Phytium x100 HDMI with the driver pmdk-dp

---
 src/Makefile.am                               |  7 +++-
 src/modules/alsa/alsa-mixer.c                 |  7 +++-
 .../profile-sets/90-pulseaudio-x100.rules     | 26 +++++++++++++
 .../phytium-pmdk-dp-x100-hdmi.conf            | 38 +++++++++++++++++++
 4 files changed, 75 insertions(+), 3 deletions(-)
 create mode 100644 src/modules/alsa/mixer/profile-sets/90-pulseaudio-x100.rules
 create mode 100644 src/modules/alsa/mixer/profile-sets/phytium-pmdk-dp-x100-hdmi.conf

diff --git a/src/Makefile.am b/src/Makefile.am
index 4755948..40feb01 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1330,11 +1330,14 @@ dist_alsaprofilesets_DATA = \
 		modules/alsa/mixer/profile-sets/loongson-laptop-audio.conf \
 		modules/alsa/mixer/profile-sets/dahua-4f05-usb-audio.conf \
 		modules/alsa/mixer/profile-sets/lenovo-m90h-usb-audio.conf \
-		modules/alsa/mixer/profile-sets/unis-4f18-usb-audio.conf
+		modules/alsa/mixer/profile-sets/unis-4f18-usb-audio.conf \
+		modules/alsa/mixer/profile-sets/phytium-pmdk-dp-x100-hdmi.conf
 
 if HAVE_UDEV
 dist_udevrules_DATA = \
-		modules/alsa/mixer/profile-sets/90-pulseaudio.rules
+		modules/alsa/mixer/profile-sets/90-pulseaudio.rules \
+		modules/alsa/mixer/profile-sets/90-pulseaudio-x100.rules
+
 endif
 
 dist_alsapaths_DATA = \
diff --git a/src/modules/alsa/alsa-mixer.c b/src/modules/alsa/alsa-mixer.c
index 914ece8..d6eae9b 100644
--- a/src/modules/alsa/alsa-mixer.c
+++ b/src/modules/alsa/alsa-mixer.c
@@ -4754,7 +4754,12 @@ void pa_alsa_profile_set_cust_paths(pa_alsa_profile_set *ps, const char *cust_fo
 
     pa_log_debug("open directory: '%s'", fn);
 
-    dir = opendir(fn);
+    if (!(dir = opendir(fn))) {
+        pa_log_warn("Failed to open %s",fn);
+        pa_xfree(fn);
+        return;
+    }
+
     while ((ent = readdir(dir)) != NULL) {
         if (pa_streq(ent->d_name, ".") || pa_streq(ent->d_name, ".."))
             continue;
diff --git a/src/modules/alsa/mixer/profile-sets/90-pulseaudio-x100.rules b/src/modules/alsa/mixer/profile-sets/90-pulseaudio-x100.rules
new file mode 100644
index 0000000..02053ec
--- /dev/null
+++ b/src/modules/alsa/mixer/profile-sets/90-pulseaudio-x100.rules
@@ -0,0 +1,26 @@
+# do not edit this file, it will be overwritten on update
+  
+# This file is part of PulseAudio.
+#
+# PulseAudio is free software; you can redistribute it and/or modify
+# it under the terms of the GNU Lesser General Public License as
+# published by the Free Software Foundation; either version 2.1 of the
+# License, or (at your option) any later version.
+#
+# PulseAudio is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+# Lesser General Public License for more details.
+#
+# You should have received a copy of the GNU Lesser General Public License
+# along with PulseAudio; if not, see <http://www.gnu.org/licenses/>.
+
+SUBSYSTEM!="sound", GOTO="pulseaudio_end"
+ACTION!="change", GOTO="pulseaudio_end"
+KERNEL!="card*", GOTO="pulseaudio_end"
+SUBSYSTEMS=="usb", GOTO="pulseaudio_check_usb"
+
+SUBSYSTEMS=="platform", DRIVERS=="pmdk_dp", ENV{PULSE_PROFILE_SET}="phytium-pmdk-dp-x100-hdmi.conf"
+
+GOTO="pulseaudio_end"
+
diff --git a/src/modules/alsa/mixer/profile-sets/phytium-pmdk-dp-x100-hdmi.conf b/src/modules/alsa/mixer/profile-sets/phytium-pmdk-dp-x100-hdmi.conf
new file mode 100644
index 0000000..662ab66
--- /dev/null
+++ b/src/modules/alsa/mixer/profile-sets/phytium-pmdk-dp-x100-hdmi.conf
@@ -0,0 +1,38 @@
+# This file is part of PulseAudio.
+# 
+# PulseAudio is free software; you can redistribute it and/or modify
+# it under the terms of the GNU Lesser General Public License as
+# published by the Free Software Foundation; either version 2.1 of the
+# License, or (at your option) any later version.
+#
+# PulseAudio is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+# General Public License for more details.
+#
+# You should have received a copy of the GNU Lesser General Public License
+# along with PulseAudio; if not, see <http://www.gnu.org/licenses/>.
+
+;
+;
+; See default.conf for an explanation on the directives used here.
+
+[General]
+auto-profiles = yes
+
+[Mapping hdmi-stereo]
+description = Digital Stereo (HDMI)
+device-strings = hw:%f
+fallback = yes
+paths-output = hdmi-output-0
+channel-map = left,right
+priority = 9
+direction = output
+
+[Mapping hdmi-stereo-extra1]
+description = Digital Stereo (HDMI 2)
+device-strings = hw:%f,1
+paths-output = hdmi-output-1
+channel-map = left,right
+priority = 7
+direction = output
-- 
2.20.1

